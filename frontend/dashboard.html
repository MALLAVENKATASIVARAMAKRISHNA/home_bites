<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - Home Bites</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="./styles.css" />
  <link rel="stylesheet" href="./dashboard.css?v=2" />
</head>
<body>
  <div class="dashboard order-dashboard">
    <nav class="dash-nav">
      <div class="dash-brand">
        <img src="./assets/logo.png" alt="Home Bites logo" />
        <div>
          <strong>Home Bites</strong>
          <p>Order fresh home-cooked food</p>
        </div>
      </div>

      <div class="dash-search-wrap">
        <input id="itemSearch" type="text" placeholder="Search for dishes, sweets, snacks..." aria-label="Search items" />
      </div>

      <div class="dash-actions">
        <div class="order-profile-wrap">
          <button
            id="profileBtn"
            class="order-profile-btn"
            type="button"
            aria-haspopup="true"
            aria-expanded="false"
            onclick="toggleProfileMenu()"
          >
            <span id="profileInitial">U</span>
          </button>

          <div id="profileMenu" class="order-profile-menu" aria-hidden="true">
            <h4>My Profile</h4>
            <div class="profile-row"><span>Name</span><strong id="profileName">-</strong></div>
            <div class="profile-row"><span>Email</span><strong id="profileEmail">-</strong></div>
            <div class="profile-row"><span>Phone</span><strong id="profilePhone">-</strong></div>
            <div class="profile-row"><span>Address</span><strong id="profileAddress">-</strong></div>
            <div class="profile-row"><span>City</span><strong id="profileCity">-</strong></div>
            <div class="profile-row"><span>Role</span><strong id="profileRole">-</strong></div>
            <button class="profile-orders-btn" type="button" onclick="showMyOrders()">My Orders</button>
            <button class="profile-logout-btn" type="button" onclick="logout()">Logout</button>
          </div>
        </div>
      </div>
    </nav>

    <main class="order-main">
      <section class="order-hero">
        <h1>Craving something homemade?</h1>
        <p>Pick your favorites, add to cart, and place your order in one step.</p>
      </section>

      <section id="categoryChips" class="category-chips"></section>

      <section class="order-layout">
        <section class="catalog-panel">
          <div class="panel-head">
            <h2>Available Items</h2>
            <span id="itemsMeta">Loading...</span>
          </div>

          <div id="loadingMsg" class="loading-block">Loading items...</div>
          <div id="itemsGrid" class="food-grid" style="display: none;"></div>
        </section>
      </section>
    </main>
  </div>

  <button id="goToCartBtn" class="bottom-cart-btn" type="button" onclick="openCartDrawer()">
    Go to Cart <span id="quickCartCount">0</span>
  </button>

  <div id="cartDrawer" class="cart-drawer" aria-hidden="true">
    <div class="cart-drawer-overlay" onclick="closeCartDrawer()"></div>
    <aside class="cart-panel drawer-panel">
      <div class="panel-head">
        <h2>Your Cart</h2>
        <div class="cart-head-actions">
          <span id="cartCount">0 items</span>
          <button class="drawer-close-btn" type="button" onclick="closeCartDrawer()">Close</button>
        </div>
      </div>

      <div id="cartEmpty" class="cart-empty">No items in cart yet.</div>
      <div id="cartItems" class="cart-items"></div>

      <div class="cart-summary">
        <div class="summary-row"><span>Subtotal</span><strong id="cartSubtotal">Rs 0</strong></div>

        <label for="paymentMode">Payment Mode</label>
        <select id="paymentMode">
          <option value="cash">Cash</option>
          <option value="upi">UPI</option>
          <option value="card">Card</option>
        </select>

        <button id="placeOrderBtn" class="place-order-btn" type="button" onclick="placeOrder()">Place Order</button>
        <p class="cart-note">Delivery address will use your profile details.</p>
      </div>
    </aside>
  </div>

  <script src="./config.js"></script>
  <script src="./ui.js"></script>
  <script>
    const token = localStorage.getItem('access_token');
    let user = JSON.parse(localStorage.getItem('user') || '{}');

    if (!token) {
      window.location.href = './index.html';
    }

    let allItems = [];
    let selectedCategory = 'All';
    let searchText = '';
    const cart = {};

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text ?? '';
      return div.innerHTML;
    }

    function formatValue(value) {
      if (value === null || value === undefined) return '-';
      const text = String(value).trim();
      return text || '-';
    }

    function formatRole(role) {
      const value = formatValue(role);
      if (value === '-') return value;
      return value.charAt(0).toUpperCase() + value.slice(1);
    }

    function formatCurrency(amount) {
      return `Rs ${Number(amount || 0)}`;
    }

    function getUserInitial() {
      const name = (user.name || '').trim();
      return name ? name.charAt(0).toUpperCase() : 'U';
    }

    function renderProfile() {
      document.getElementById('profileInitial').textContent = getUserInitial();
      document.getElementById('profileName').textContent = formatValue(user.name);
      document.getElementById('profileEmail').textContent = formatValue(user.email);
      document.getElementById('profilePhone').textContent = formatValue(user.phone_number);
      document.getElementById('profileAddress').textContent = formatValue(user.address);
      document.getElementById('profileCity').textContent = formatValue(user.city);
      document.getElementById('profileRole').textContent = formatRole(user.role);
    }

    function getOrdersStorageKey() {
      return `home_bites_orders_${user.user_id || 'guest'}`;
    }

    function getSavedOrders() {
      try {
        return JSON.parse(localStorage.getItem(getOrdersStorageKey()) || '[]');
      } catch (err) {
        return [];
      }
    }

    function saveOrderRecord(orderRecord) {
      const orders = getSavedOrders();
      orders.unshift(orderRecord);
      localStorage.setItem(getOrdersStorageKey(), JSON.stringify(orders.slice(0, 30)));
    }

    function toggleProfileMenu() {
      const menu = document.getElementById('profileMenu');
      const btn = document.getElementById('profileBtn');
      const isOpen = menu.classList.toggle('active');
      btn.setAttribute('aria-expanded', String(isOpen));
      menu.setAttribute('aria-hidden', String(!isOpen));
    }

    function closeProfileMenu() {
      const menu = document.getElementById('profileMenu');
      const btn = document.getElementById('profileBtn');
      menu.classList.remove('active');
      btn.setAttribute('aria-expanded', 'false');
      menu.setAttribute('aria-hidden', 'true');
    }

    document.addEventListener('click', (event) => {
      const wrapper = document.querySelector('.order-profile-wrap');
      if (wrapper && !wrapper.contains(event.target)) {
        closeProfileMenu();
      }
    });

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape') {
        closeProfileMenu();
        closeCartDrawer();
      }
    });

    async function hydrateProfileDetails() {
      const missingProfileData = !user.phone_number || !user.address || !user.city;
      if (!missingProfileData) return;

      try {
        const res = await fetch(`${API_BASE_URL}/me`, {
          headers: { Authorization: `Bearer ${token}` }
        });

        if (!res.ok) return;
        const profile = await res.json();
        user = { ...user, ...profile };
        localStorage.setItem('user', JSON.stringify(user));
      } catch (err) {
        console.warn('Could not refresh profile details:', err);
      }
    }

    function categorizeItem(item) {
      const text = `${item.item_name || ''} ${item.description || ''}`.toLowerCase();
      if (text.includes('sweet') || text.includes('laddu') || text.includes('halwa')) return 'Sweets';
      if (text.includes('snack') || text.includes('mixture') || text.includes('murukku')) return 'Snacks';
      if (text.includes('meal') || text.includes('rice') || text.includes('curry')) return 'Meals';
      return 'Specials';
    }

    function renderCategoryChips(items) {
      const chipsWrap = document.getElementById('categoryChips');
      const categories = ['All', ...Array.from(new Set(items.map(categorizeItem)))];
      chipsWrap.innerHTML = categories
        .map(cat => `<button type="button" class="chip ${cat === selectedCategory ? 'active' : ''}" data-cat="${escapeHtml(cat)}">${escapeHtml(cat)}</button>`)
        .join('');

      chipsWrap.querySelectorAll('.chip').forEach(btn => {
        btn.addEventListener('click', () => {
          selectedCategory = btn.dataset.cat || 'All';
          renderCategoryChips(allItems);
          renderItems();
        });
      });
    }

    function getFilteredItems() {
      return allItems.filter(item => {
        const categoryOk = selectedCategory === 'All' || categorizeItem(item) === selectedCategory;
        const query = searchText.trim().toLowerCase();
        const text = `${item.item_name || ''} ${item.description || ''} ${item.weight || ''}`.toLowerCase();
        const searchOk = !query || text.includes(query);
        return categoryOk && searchOk;
      });
    }

    function getItemQuantity(itemId) {
      return cart[itemId]?.quantity || 0;
    }

    function addToCart(itemId) {
      const item = allItems.find(i => i.item_id === itemId);
      if (!item) return;

      if (!cart[itemId]) {
        cart[itemId] = { item, quantity: 1 };
      } else {
        cart[itemId].quantity += 1;
      }

      renderItems();
      renderCart();
    }

    function decrementFromCart(itemId) {
      if (!cart[itemId]) return;
      cart[itemId].quantity -= 1;
      if (cart[itemId].quantity <= 0) delete cart[itemId];
      renderItems();
      renderCart();
    }

    function renderItems() {
      const itemsGrid = document.getElementById('itemsGrid');
      const filteredItems = getFilteredItems();
      document.getElementById('itemsMeta').textContent = `${filteredItems.length} items`;

      if (filteredItems.length === 0) {
        itemsGrid.innerHTML = '<p class="empty-grid">No items found for this filter.</p>';
        return;
      }

      itemsGrid.innerHTML = filteredItems.map(item => {
        const qty = getItemQuantity(item.item_id);
        return `
          <article class="food-card">
            <div class="food-top">
              <div class="food-badge">${escapeHtml(categorizeItem(item))}</div>
              <h3>${escapeHtml(item.item_name)}</h3>
              <p>${escapeHtml(item.description || 'Freshly prepared homemade food.')}</p>
            </div>

            <div class="food-bottom">
              <div>
                <span class="food-meta">${escapeHtml(item.weight || 'Standard')}</span>
                <strong>${formatCurrency(item.price)}</strong>
              </div>

              <div class="food-actions">
                ${qty === 0 ? `
                  <button type="button" class="add-btn" onclick="addToCart(${item.item_id})">Add</button>
                ` : `
                  <div class="qty-stepper">
                    <button type="button" onclick="decrementFromCart(${item.item_id})">-</button>
                    <span>${qty}</span>
                    <button type="button" onclick="addToCart(${item.item_id})">+</button>
                  </div>
                `}
              </div>
            </div>
          </article>
        `;
      }).join('');
    }

    function renderCart() {
      const entries = Object.values(cart);
      const cartItemsEl = document.getElementById('cartItems');
      const cartEmptyEl = document.getElementById('cartEmpty');

      const totalItems = entries.reduce((sum, entry) => sum + entry.quantity, 0);
      const subtotal = entries.reduce((sum, entry) => sum + (entry.item.price * entry.quantity), 0);

      document.getElementById('cartCount').textContent = `${totalItems} item${totalItems === 1 ? '' : 's'}`;
      document.getElementById('quickCartCount').textContent = String(totalItems);
      document.getElementById('cartSubtotal').textContent = formatCurrency(subtotal);

      if (entries.length === 0) {
        cartEmptyEl.style.display = 'block';
        cartItemsEl.innerHTML = '';
        return;
      }

      cartEmptyEl.style.display = 'none';
      cartItemsEl.innerHTML = entries.map(({ item, quantity }) => `
        <div class="cart-line">
          <div>
            <h4>${escapeHtml(item.item_name)}</h4>
            <p>${quantity} x ${formatCurrency(item.price)}</p>
          </div>
          <div class="qty-stepper">
            <button type="button" onclick="decrementFromCart(${item.item_id})">-</button>
            <span>${quantity}</span>
            <button type="button" onclick="addToCart(${item.item_id})">+</button>
          </div>
        </div>
      `).join('');
    }

    async function loadItems() {
      const loadingMsg = document.getElementById('loadingMsg');
      const itemsGrid = document.getElementById('itemsGrid');

      try {
        const res = await fetch(`${API_BASE_URL}/items`);
        if (!res.ok) throw new Error('Failed to load items');

        const items = await res.json();
        allItems = Array.isArray(items) ? items : [];

        loadingMsg.style.display = 'none';
        itemsGrid.style.display = 'grid';

        renderCategoryChips(allItems);
        renderItems();
      } catch (err) {
        loadingMsg.innerHTML = `<span style="color: var(--danger);">Error: ${err.message}</span>`;
        console.error('Failed to load items:', err);
      }
    }

    async function placeOrder() {
      const placeOrderBtn = document.getElementById('placeOrderBtn');
      const entries = Object.values(cart);

      if (entries.length === 0) {
        alert('Add at least one item to place an order.');
        return;
      }

      if (!user.user_id) {
        alert('User session is incomplete. Please login again.');
        return;
      }

      if (!user.address || !user.city) {
        alert('Address/City missing in profile. Please update your profile and login again.');
        return;
      }

      const today = new Date();
      const orderDate = today.toISOString().slice(0, 10);
      const deliveryDate = new Date(today.getTime() + 24 * 60 * 60 * 1000).toISOString().slice(0, 10);

      const payload = {
        user_id: user.user_id,
        order_status: 'pending',
        payment_status: 'pending',
        payment_mode: document.getElementById('paymentMode').value,
        order_date: orderDate,
        delivery_date: deliveryDate,
        address: String(user.address || '').trim(),
        city: String(user.city || '').trim(),
        items: entries.map(({ item, quantity }) => ({
          item_id: item.item_id,
          quantity,
          price: item.price
        }))
      };

      try {
        setButtonLoading(placeOrderBtn, 'Placing Order...', true);

        const res = await fetch(`${API_BASE_URL}/orders/complete`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${token}`
          },
          body: JSON.stringify(payload)
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || 'Order failed');

        alert(`Order placed successfully! Order ID: ${data.order_id}`);
        saveOrderRecord({
          order_id: data.order_id,
          order_status: payload.order_status,
          payment_status: payload.payment_status,
          order_date: payload.order_date,
          delivery_date: payload.delivery_date,
          payment_mode: payload.payment_mode,
          address: payload.address,
          city: payload.city,
          items_count: payload.items.length,
          total_amount: data.total_amount,
          items: entries.map(({ item, quantity }) => ({
            item_id: item.item_id,
            item_name: item.item_name,
            quantity,
            unit_price: item.price,
            line_total: item.price * quantity,
            weight: item.weight || ''
          }))
        });

        Object.keys(cart).forEach(key => delete cart[key]);
        renderItems();
        renderCart();
      } catch (err) {
        alert(`Could not place order: ${err.message}`);
      } finally {
        setButtonLoading(placeOrderBtn, 'Place Order', false);
      }
    }

    function openCartDrawer() {
      const drawer = document.getElementById('cartDrawer');
      drawer.classList.add('active');
      drawer.setAttribute('aria-hidden', 'false');
      document.body.style.overflow = 'hidden';
    }

    function closeCartDrawer() {
      const drawer = document.getElementById('cartDrawer');
      drawer.classList.remove('active');
      drawer.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = 'auto';
    }

    document.getElementById('itemSearch').addEventListener('input', (event) => {
      searchText = event.target.value || '';
      renderItems();
    });

    function logout() {
      localStorage.removeItem('access_token');
      localStorage.removeItem('user');
      window.location.href = './index.html';
    }

    function showMyOrders() {
      closeProfileMenu();
      window.location.href = './my-orders.html';
    }

    async function init() {
      await hydrateProfileDetails();
      renderProfile();
      renderCart();
      await loadItems();
    }

    init();
  </script>
</body>
</html>
