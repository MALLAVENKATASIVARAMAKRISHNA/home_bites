<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Orders - Home Bites</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="./styles.css" />
  <link rel="stylesheet" href="./dashboard.css?v=3" />
</head>
<body>
  <div class="dashboard order-dashboard">
    <nav class="dash-nav">
      <div class="dash-brand">
        <img src="./assets/logo.png" alt="Home Bites logo" />
        <div>
          <strong>Home Bites</strong>
          <p>Order history</p>
        </div>
      </div>

      <div class="dash-search-wrap order-page-search-note">
        <p>Your recent placed orders are shown below.</p>
      </div>

      <div class="dash-actions">
        <button class="cart-quick-btn" type="button" onclick="goToDashboard()">Back to Dashboard</button>
        <button class="profile-logout-btn small-logout" type="button" onclick="logout()">Logout</button>
      </div>
    </nav>

    <main class="order-main">
      <section class="order-hero">
        <h1>My Orders</h1>
        <p>Track all your recent Home Bites orders in one place.</p>
      </section>

      <section class="orders-page-panel">
        <div class="panel-head">
          <h2>Order History</h2>
          <span id="ordersMeta">0 orders</span>
        </div>

        <div id="ordersContent" class="orders-content"></div>
      </section>
    </main>
  </div>

  <script src="./config.js"></script>
  <script>
    const token = localStorage.getItem('access_token');
    const user = JSON.parse(localStorage.getItem('user') || '{}');
    let activeOrderIndex = null;
    let ordersCache = [];

    if (!token) {
      window.location.href = './index.html';
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text ?? '';
      return div.innerHTML;
    }

    function formatCurrency(amount) {
      return `Rs ${Number(amount || 0)}`;
    }

    function getOrdersStorageKey() {
      return `home_bites_orders_${user.user_id || 'guest'}`;
    }

    function getSavedOrders() {
      try {
        return JSON.parse(localStorage.getItem(getOrdersStorageKey()) || '[]');
      } catch (err) {
        return [];
      }
    }

    function setSavedOrders(orders) {
      localStorage.setItem(getOrdersStorageKey(), JSON.stringify(orders.slice(0, 50)));
    }

    function mergeOrders(remoteOrders, localOrders) {
      const map = new Map();
      localOrders.forEach(order => {
        map.set(order.order_id, order);
      });
      remoteOrders.forEach(order => {
        const existing = map.get(order.order_id) || {};
        map.set(order.order_id, { ...existing, ...order });
      });
      return Array.from(map.values()).sort((a, b) => Number(b.order_id || 0) - Number(a.order_id || 0));
    }

    async function loadOrdersFromBackend() {
      if (!user.user_id) return getSavedOrders();
      const localOrders = getSavedOrders();

      try {
        const res = await fetch(`${API_BASE_URL}/users/${user.user_id}/orders`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        if (!res.ok) throw new Error('Failed to load orders');

        const remoteOrders = await res.json();
        const merged = mergeOrders(Array.isArray(remoteOrders) ? remoteOrders : [], localOrders);
        setSavedOrders(merged);
        return merged;
      } catch (err) {
        return localOrders;
      }
    }

    function renderOrderItems(order) {
      if (!Array.isArray(order.items) || order.items.length === 0) {
        return '<p class="order-item-empty">Detailed item list not available for this order.</p>';
      }

      return `
        <div class="order-items-list">
          ${order.items.map(item => `
            <div class="order-item-row">
              <div>
                <strong>${escapeHtml(item.item_name || `Item #${item.item_id || '-'}`)}</strong>
                <p>${Number(item.quantity || 0)} x ${formatCurrency(item.unit_price || 0)} ${item.weight ? `â€¢ ${escapeHtml(item.weight)}` : ''}</p>
              </div>
              <span>${formatCurrency(item.line_total || 0)}</span>
            </div>
          `).join('')}
        </div>
      `;
    }

    function getStatusText(value) {
      const text = String(value || '').trim();
      return text || '-';
    }

    async function handleOrderCardClick(event) {
      const card = event.target.closest('.order-history-card');
      if (!card) return;
      const index = Number(card.dataset.index);
      if (!Number.isInteger(index)) return;

      if (activeOrderIndex === index) {
        activeOrderIndex = null;
        renderOrdersPage();
        return;
      }

      activeOrderIndex = index;
      const selectedOrder = ordersCache[index];
      if (selectedOrder && (!Array.isArray(selectedOrder.items) || selectedOrder.items.length === 0)) {
        try {
          const res = await fetch(`${API_BASE_URL}/orders/${selectedOrder.order_id}/complete`, {
            headers: { Authorization: `Bearer ${token}` }
          });
          if (res.ok) {
            const detail = await res.json();
            const detailedItems = Array.isArray(detail.items) ? detail.items.map(item => ({
              item_id: item.item_id,
              item_name: item.item_name,
              quantity: item.quantity,
              unit_price: item.price,
              line_total: Number(item.price || 0) * Number(item.quantity || 0),
              weight: item.weight || ''
            })) : [];
            ordersCache[index] = {
              ...selectedOrder,
              ...detail.order,
              items: detailedItems,
              items_count: detailedItems.length || selectedOrder.items_count
            };
            setSavedOrders(ordersCache);
          }
        } catch (err) {
          // Keep existing summary data if detail call fails
        }
      }

      renderOrdersPage();
    }

    function renderOrdersPage() {
      const orders = ordersCache;
      const container = document.getElementById('ordersContent');
      document.getElementById('ordersMeta').textContent = `${orders.length} order${orders.length === 1 ? '' : 's'}`;

      if (!orders.length) {
        container.innerHTML = `
          <div class="orders-empty-page">
            <h3>No orders yet</h3>
            <p>Start adding items from dashboard and place your first order.</p>
            <button type="button" class="place-order-btn" onclick="goToDashboard()">Go to Dashboard</button>
          </div>
        `;
        return;
      }

      container.innerHTML = orders.map((order, index) => `
        <article class="order-history-card clickable ${activeOrderIndex === index ? 'active' : ''}" data-index="${index}">
          <div class="order-history-head">
            <strong>Order #${order.order_id}</strong>
            <span>${escapeHtml(getStatusText(order.order_status || 'pending'))}</span>
          </div>
          <p><b>Date:</b> ${escapeHtml(order.order_date || '-')}</p>
          <p><b>Amount:</b> ${formatCurrency(order.total_amount || 0)}</p>
          <p><b>Payment:</b> ${escapeHtml(order.payment_mode || '-')}</p>
          <p><b>Items:</b> ${Number(order.items_count || 0)}</p>
          <p><b>Delivery:</b> ${escapeHtml(order.delivery_date || '-')}</p>
          <p class="view-order-note">Click to ${activeOrderIndex === index ? 'hide' : 'view'} full details</p>

          <div class="order-history-details ${activeOrderIndex === index ? 'active' : ''}">
            <div class="order-detail-grid">
              <p><b>Order Status:</b> ${escapeHtml(getStatusText(order.order_status || 'pending'))}</p>
              <p><b>Payment Status:</b> ${escapeHtml(getStatusText(order.payment_status || 'pending'))}</p>
              <p><b>Order Date:</b> ${escapeHtml(order.order_date || '-')}</p>
              <p><b>Delivery Date:</b> ${escapeHtml(order.delivery_date || '-')}</p>
              <p><b>Address:</b> ${escapeHtml(order.address || '-')}</p>
              <p><b>City:</b> ${escapeHtml(order.city || '-')}</p>
            </div>
            <h4>Items</h4>
            ${renderOrderItems(order)}
          </div>
        </article>
      `).join('');

      container.querySelectorAll('.order-history-card').forEach(card => {
        card.addEventListener('click', handleOrderCardClick);
      });
    }

    function goToDashboard() {
      window.location.href = './dashboard.html';
    }

    function logout() {
      localStorage.removeItem('access_token');
      localStorage.removeItem('user');
      window.location.href = './index.html';
    }

    async function init() {
      ordersCache = await loadOrdersFromBackend();
      renderOrdersPage();
    }

    init();
  </script>
</body>
</html>
